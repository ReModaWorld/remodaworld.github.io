<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ReModa™ | Project Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  :root{
    --navy:#0C1D3A; --navy-700:#122a58; --bg:#0a1227; --white:#fff;
    --ink:#0f1830; --muted:#6e7aa1; --accent:#7cc6ff; --hqglow:#FFD36E;
    --radius:16px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--white);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .page{display:grid;grid-template-rows:auto 1fr;height:100%}

  /* Top bar */
  .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between;
    padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg,var(--navy),#0b1f3f)}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:40px;width:auto}
  .brand .title-wrap{display:flex;flex-direction:column;line-height:1.1}
  .brand .title-wrap span{font-weight:700;letter-spacing:.2px}
  .map-subtitle{font-size:13px;color:rgba(255,255,255,0.7);margin-top:2px}
  .topbar a{color:#cfe8ff;text-decoration:none;font-size:14px}
  .topbar button{background:transparent;border:1px solid rgba(255,255,255,.3);color:#cfe8ff;border-radius:10px;padding:6px 10px;cursor:pointer}

  .map-wrap{position:relative}
  #map{position:absolute;inset:0}
  .map-tint{position:absolute;inset:0;pointer-events:none;z-index:300;
    background:radial-gradient(900px 520px at 50% -8%, rgba(12,29,58,.35) 0%, transparent 60%),
               linear-gradient(180deg, rgba(12,29,58,.40), rgba(12,29,58,.30));
    mix-blend-mode:multiply;}

  /* Controls (filter panel) — scrollable body */
  .controls{
    position:absolute;top:16px;right:16px;z-index:500;width:min(400px, calc(100vw - 32px));
    background:linear-gradient(180deg, rgba(255,255,255,.97), rgba(255,255,255,.94));
    color:var(--ink);border:1px solid rgba(0,0,0,.08); border-radius:var(--radius);
    overflow:hidden; box-shadow:0 18px 48px rgba(0,0,0,.35);
    display:flex; flex-direction:column;
    max-height:min(88vh, 760px);
  }
  .ribbon{
    display:flex;align-items:center;justify-content:space-between;
    gap:10px;padding:10px 14px;background:linear-gradient(180deg,#133063,#0C1D3A);color:#eaf2ff;border-bottom:1px solid rgba(255,255,255,.08)
  }
  .ribbon img{height:32px;width:auto}
  .ribbon strong{font-size:13px;letter-spacing:.3px}
  .icon-close{
    appearance:none; border:1px solid rgba(255,255,255,.45);
    background:transparent; color:#fff; font-weight:700;
    width:28px; height:28px; line-height:26px; text-align:center;
    border-radius:8px; cursor:pointer; padding:0;
  }
  .icon-close:hover{ background:rgba(255,255,255,.08); }

  .controls header{padding:10px 14px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;justify-content:space-between;align-items:center}
  .controls h2{margin:0;font-size:15px;color:var(--navy)}
  .controls .body{
    padding:12px 14px;display:grid;gap:10px;
    overflow:auto; flex:1;
  }
  label{font-size:12px;color:var(--navy);font-weight:700}
  input,select,button{width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#f5f7fb;color:var(--ink);padding:10px 12px;font-size:14px;outline:none}
  input::placeholder{color:#6b7a9b}
  input:focus,select:focus{border-color:var(--navy-700);box-shadow:0 0 0 3px rgba(18,42,88,.18)}
  .row{display:grid;gap:8px}
  .row.inline{grid-template-columns:1fr 1fr;gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid rgba(0,0,0,.15);padding:8px 12px;border-radius:999px;background:#fff;font-size:12px;cursor:pointer;color:var(--ink);font-weight:600}
  .chip.active{border-color:var(--navy-700);box-shadow:0 0 0 2px rgba(18,42,88,.18) inset}
  .footer{padding:10px 14px;border-top:1px solid rgba(0,0,0,.06);display:flex;gap:10px}
  .btn{background:linear-gradient(180deg,#1c3872,#122a58);border:1px solid rgba(0,0,0,.15);padding:10px 12px;border-radius:12px;color:#eaf2ff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#eef2fb;color:var(--ink)}

  /* Premium popup card */
  .pop-card{background:#0c1633;color:#eaf2ff;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.14)}
  .pop-card .hero{width:100%;height:180px;background:#111 center/cover;border-bottom:1px solid rgba(255,255,255,.12)}
  .pop-card .inner{padding:12px 14px}
  .pop-card h3{margin:0 0 4px;font-size:16px;font-weight:800;letter-spacing:.2px}
  .pop-card .meta{margin:0 0 8px;font-size:12px;color:#cfe0ff}
  .pop-card p{margin:0;color:#cfe0ff;line-height:1.35}
  .pop-card .cta{display:inline-block;margin-top:10px;padding:8px 12px;border-radius:10px;
    background:#1c3872;border:1px solid rgba(255,255,255,.15);color:#fff !important;text-decoration:none;font-weight:700}
  .pop-card .cta:hover{filter:brightness(1.08);text-decoration:underline}
  .cta-container{display:flex;gap:10px;margin-top:10px}
  .cta-container .cta{flex:1;text-align:center}
  .leaflet-popup{z-index:1000 !important}

  /* HQ pin — glow + logo (UNCHANGED) */
  .rmd-hq{
    width:44px;height:44px;border-radius:50%;
    background:#0C1D3A url('images/remoda-pin.png?v=3') center/88% no-repeat;
    box-shadow:0 0 0 3px #0c1633,0 0 24px rgba(255,211,110,.95),0 0 70px rgba(255,211,110,.60);
    position:relative;
  }
  .rmd-hq::before{content:"";position:absolute;inset:-6px;border-radius:50%;box-shadow:0 0 0 2px rgba(255,211,110,.6)}
  .rmd-hq::after{content:"";position:absolute;inset:0;border-radius:50%;box-shadow:0 0 0 0 rgba(255,211,110,.7);animation:rmdPulse 2.2s ease-out infinite}
  @keyframes rmdPulse{0%{box-shadow:0 0 0 0 rgba(255,211,110,.7)}60%{box-shadow:0 0 0 28px rgba(255,211,110,0)}100%{box-shadow:0 0 0 0 rgba(255,211,110,0)}}

  /* Clusters */
  .marker-cluster-small,.marker-cluster-medium,.marker-cluster-large{background:rgba(16,46,102,.88);color:#eaf2ff;border:2px solid #9bc9ff;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .marker-cluster div{background:transparent;color:#eaf2ff;font-weight:800;border:none}

  /* Privacy note (above map, under panel) */
  .privacy-note{
    position:absolute; left:50%; bottom:10px; transform:translateX(-50%);
    z-index:400; display:flex; align-items:center; gap:8px;
    font-size:12px; color:rgba(255,255,255,.88);
    padding:6px 10px; border-radius:10px;
    background:rgba(12,29,58,.45);
    -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px);
    border:1px solid rgba(255,255,255,.12);
    pointer-events:none;
  }
  .privacy-note svg{width:14px;height:14px;flex:none;opacity:.95}

  @media (max-width:720px){
    .controls{left:50%;right:auto;transform:translateX(-50%);width:min(94vw,420px)}
    .brand img{height:32px;}
    .ribbon img{height:26px;}
    .privacy-note{font-size:11px; padding:6px 8px; bottom:8px;}
    .icon-close{ width:32px; height:32px; line-height:30px; }
  }
</style>
</head>
<body>
<div class="page">
  <div class="topbar">
    <div class="brand">
      <img src="images/remoda-logo.png" alt="ReModa Logo">
      <div class="title-wrap">
        <span>Project Map</span>
        <div class="map-subtitle">Explore completed ReModa™ projects across Dallas–Fort Worth. Filter by service type to see our work near you.</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <a href="/">Home</a>
      <button id="toggleFilters" aria-expanded="false">Filters</button>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map" aria-label="Interactive map of ReModa completed projects"></div>
    <div class="map-tint" aria-hidden="true"></div>

    <!-- Privacy disclaimer with shield icon -->
    <div class="privacy-note" aria-live="polite">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 2.5l7 3v6.3c0 4.2-2.7 8-7 10.2-4.3-2.2-7-6-7-10.2V5.5l7-3z" stroke="white" stroke-width="1.4" fill="rgba(255,255,255,.12)"/>
        <path d="M9.2 12.3l1.8 1.8 3.8-4.1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>We respect our clients’ privacy — locations are approximate, not exact.</span>
    </div>

    <aside class="controls" aria-label="Project filters">
      <div class="ribbon">
        <div style="display:flex;align-items:center;gap:10px">
          <img src="images/remoda-logo.png" alt="ReModa">
          <strong>ReModa™ • Filter Projects</strong>
        </div>
        <button id="closeFilters" class="icon-close" aria-label="Close filters">×</button>
      </div>
      <header>
        <h2>Explore Completed Projects</h2>
        <small style="color:var(--muted)">Dallas–Fort Worth</small>
      </header>
      <div class="body">
        <div class="row">
          <label for="q">Search</label>
          <input id="q" type="search" placeholder="Client, project, notes…"/>
        </div>
        <div class="row inline">
          <div>
            <label for="city">City</label>
            <select id="city"><option value="">All Cities</option></select>
          </div>
          <div>
            <label for="year">Year</label>
            <select id="year"><option value="">All Years</option></select>
          </div>
        </div>

        <!-- Project Type chips (Residential/Commercial) -->
        <div class="row">
          <label>Project Type</label>
          <div id="ptype" class="chips"></div>
        </div>

        <div class="row">
          <label>Service Type</label>
          <div id="services" class="chips"></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="apply">Apply Filters</button>
        <button class="btn secondary" id="reset">Reset</button>
      </div>
    </aside>
  </div>
</div>

<script>
  /* ===========================
     SETTINGS (SIZE TWEAK)
     ===========================
     👇👇👇  CHANGE THESE IF YOU WANT BIGGER/SMALLER ICONS  👇👇👇 */
  const DATA_URL    = 'data/projects.json?v=1';
  const REMODA_NAVY = '#0C1D3A';     // glyph color
  const ICON_SIZE   = 200;           // ▲ doubled from 68 (icons only, no background)
  const GLYPH_SCALE = 0.90;          // glyph fill inside canvas (0.85–0.95 good)
  const OUTLINE     = 2.0;           // white outline for contrast on dark tiles
  /* ^^^^^^^  === ICON SIZE TWEAK HERE ===  ^^^^^^^ */

  /* Map + tiles */
  const map = L.map('map', { zoomControl:false }).setView([32.7767,-96.7970], 11);
  L.control.zoom({ position:'bottomright' }).addTo(map);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; OpenStreetMap &copy; CARTO', subdomains:'abcd', maxZoom:20
  }).addTo(map);

  /* ===== SVG GLYPH ICONS (icons only, no background) ===== */
  function glyphDataURL(innerPath){
    const inset = (ICON_SIZE - ICON_SIZE*GLYPH_SCALE)/2;
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="${ICON_SIZE}" height="${ICON_SIZE}" viewBox="0 0 ${ICON_SIZE} ${ICON_SIZE}">
  <defs>
    <filter id="ds" x="-50%" y="-50%" width="200%" height="200%">
      <feDropShadow dx="0" dy="1.2" stdDeviation="1.2" flood-color="black" flood-opacity="0.45"/>
    </filter>
  </defs>
  <g transform="translate(${inset},${inset}) scale(${GLYPH_SCALE})"
     fill="${REMODA_NAVY}" stroke="white" stroke-width="${OUTLINE}"
     stroke-linecap="round" stroke-linejoin="round" filter="url(#ds)">
    ${innerPath}
  </g>
</svg>`;
    return "data:image/svg+xml;base64," + btoa(svg);
  }

  function iconResidential(){
    const path = `
      <path d="M12 3 L3.5 10.2 M12 3 L20.5 10.2"/>
      <path d="M5.5 10.2 L5.5 20 L18.5 20 L18.5 10.2"/>
      <path d="M9 20 L9 14 L15 14 L15 20"/>
    `;
    return L.icon({
      iconUrl: glyphDataURL(path),
      iconSize:[ICON_SIZE, ICON_SIZE],
      iconAnchor:[ICON_SIZE/2, ICON_SIZE],
      popupAnchor:[0, -ICON_SIZE+4]
    });
  }

  function iconCommercial(){
    const path = `
      <path d="M6 6 L18 6 L19 10 L19 20 L5 20 L5 10 Z"/>
      <path d="M6 10 L18 10"/>
      <path d="M7.2 20 L7.2 14.8 L11 14.8 L11 20"/>
      <path d="M13 20 L13 14.8 L17 14.8 L17 20"/>
      <path d="M7 6 L17 6"/>
    `;
    return L.icon({
      iconUrl: glyphDataURL(path),
      iconSize:[ICON_SIZE, ICON_SIZE],
      iconAnchor:[ICON_SIZE/2, ICON_SIZE],
      popupAnchor:[0, -ICON_SIZE+4]
    });
  }

  // Cache icons
  const ICON_RES = iconResidential();
  const ICON_COM = iconCommercial();

  function iconFor(p){
    if (p.type === 'Residential') return ICON_RES;
    if (p.type === 'Commercial')  return ICON_COM;
    return ICON_RES; // fallback
  }

  /* Clustering */
  const clusters = L.markerClusterGroup({
    showCoverageOnHover:false, maxClusterRadius:50, spiderfyOnMaxZoom:true, disableClusteringAtZoom:15
  }).addTo(map);

  /* HQ pin (UNCHANGED) */
  const HQ_LAT = 32.9453261, HQ_LNG = -96.7355908;
  const ReModaHQIcon = L.DivIcon.extend({
    options:{ className:'rmd-hq', iconSize:[44,44], iconAnchor:[22,40], popupAnchor:[0,-34] }
  });
  L.marker([HQ_LAT, HQ_LNG], { icon:new ReModaHQIcon(), zIndexOffset:1500 })
    .addTo(map)
    .bindPopup(`
      <div class="pop-card">
        <div class="hero" style="background-image:url('images/remoda-hq.jpeg?v=3')"></div>
        <div class="inner">
          <h3>ReModa™ HQ</h3>
          <p class="meta">401 S. Sherman Street #217 • Richardson, TX 75081</p>
          <p>ReModa's Design Build headquarters.</p>
          <div class="cta-container">
            <a class="cta" href="https://www.google.com/maps/place/ReModa+%7C+Design+Build/@32.9453031,-96.7356007,17z"
               target="_blank" rel="noopener">Get Directions ›</a>
            <a class="cta" href="tel:14692099288">Call Now ›</a>
          </div>
        </div>
      </div>
    `, { maxWidth: 320 })
    .bindTooltip('ReModa HQ', { direction:'top', offset:[0,-22] });

  /* Data state */
  let allProjects = [];
  let filtered = [];
  let activeServices = new Set();
  let activeTypes = new Set();

  /* Load projects from JSON */
  async function loadData() {
    try {
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load projects.json');
      const data = await res.json();

      allProjects = (Array.isArray(data) ? data : []).map(p => ({
        id: p.id || (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Math.random())),
        title: p.title || 'Untitled Project',
        city: p.city || '',
        year: Number(p.year) || new Date().getFullYear(),
        type: normalizeType(p.type),
        services: Array.isArray(p.services) ? p.services : [],
        coords: Array.isArray(p.coords) ? p.coords : null,
        cover: p.cover || '',
        url: p.url || '',
        blurb: p.blurb || ''
      })).filter(p => Array.isArray(p.coords) && p.coords.length === 2);

      filtered = allProjects.slice();

      // Rebuild filters AFTER data loads
      document.getElementById('city').innerHTML = '<option value="">All Cities</option>';
      document.getElementById('year').innerHTML = '<option value="">All Years</option>';
      document.getElementById('services').innerHTML = '';
      document.getElementById('ptype').innerHTML = '';
      populateFilters();
      draw();
    } catch (e) {
      console.error(e);
      filtered = [];
      draw();
    }
  }

  function normalizeType(t){
    if(!t) return null;
    const s=String(t).toLowerCase().trim();
    if(s.startsWith('com')) return 'Commercial';
    if(s.startsWith('res')) return 'Residential';
    if(s.includes('store')||s.includes('salon')||s.includes('office')) return 'Commercial';
    return 'Residential';
  }

  /* Popup HTML (projects: NO CTAs) */
  function popupHTML(p){
    const services = Array.isArray(p.services) && p.services.length ? p.services.join(', ') : '';
    const metaBits = [p.city || '', p.year || ''];
    if (p.type) metaBits.push(p.type);
    const metaLine = [metaBits.filter(Boolean).join(' • '), services].filter(Boolean).join(' • ');
    return `
      <div class="pop-card">
        <div class="hero" style="background-image:url('${p.cover || ''}')"></div>
        <div class="inner">
          <h3>${p.title || 'Untitled Project'}</h3>
          ${metaLine ? `<p class="meta">${metaLine}</p>` : ''}
          ${p.blurb ? `<p>${p.blurb}</p>` : ''}
        </div>
      </div>`;
  }

  /* Filters */
  const $city = document.getElementById('city');
  const $year = document.getElementById('year');
  const $services = document.getElementById('services');
  const $ptype = document.getElementById('ptype');
  const $q = document.getElementById('q');

  const unique = (list,key)=>[...new Set(list.map(x=>x[key]))].filter(Boolean).sort();
  const uniqueYears = list => [...new Set(list.map(x=>x.year))].filter(Boolean).sort((a,b)=>b-a);

  function populateFilters(){
    unique(allProjects,'city').forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; $city.appendChild(o); });
    uniqueYears(allProjects).forEach(y=>{ const o=document.createElement('option'); o.value=y; o.textContent=y; $year.appendChild(o); });

    ['Residential','Commercial'].forEach(t=>{
      const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=t; b.dataset.value=t;
      b.onclick=()=>{ b.classList.toggle('active'); if(activeTypes.has(t)) activeTypes.delete(t); else activeTypes.add(t); };
      $ptype.appendChild(b);
    });

    ["Kitchen","Bathroom","Flooring","Painting","Exterior","Design Service","Custom Builds"].forEach(s=>{
      const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=s; b.dataset.value=s;
      b.onclick=()=>{ b.classList.toggle('active'); if(activeServices.has(s)) activeServices.delete(s); else activeServices.add(s); };
      $services.appendChild(b);
    });
  }

  function normalizeServices(list){
    const map = {
      "kitchen":"Kitchen",
      "bathroom":"Bathroom","bathrooms":"Bathroom","bath":"Bathroom",
      "floor":"Flooring","flooring":"Flooring",
      "paint":"Painting","painting":"Painting",
      "exterior":"Exterior","outdoor":"Exterior","pergola":"Exterior","patio":"Exterior",
      "design":"Design Service","design service":"Design Service","design-service":"Design Service","design-build":"Design Service",
      "custom":"Custom Builds","custom builds":"Custom Builds","millwork":"Custom Builds","feature wall":"Custom Builds","fireplace":"Custom Builds","accent wall":"Custom Builds"
    };
    return (list||[]).map(s=>String(s).toLowerCase()).map(s=>{
      if(map[s]) return map[s]; for(const k in map){ if(s.includes(k)) return map[k]; } return null;
    }).filter(Boolean).reduce((a,v)=>a.includes(v)?a:[...a,v],[]);
  }

  function draw(){
    clusters.clearLayers();
    const latlngs=[];
    filtered.forEach(p=>{
      const m=L.marker(p.coords,{icon:iconFor(p)}).bindPopup(popupHTML(p),{maxWidth:320});
      clusters.addLayer(m); latlngs.push(p.coords);
    });
    if(latlngs.length){ map.fitBounds(latlngs,{padding:[40,40]}); } else { map.flyTo([32.7767,-96.7970],11); }
  }

  function applyFilters(){
    const q=($q.value||'').toLowerCase().trim();
    const city=$city.value; const year=$year.value?+$year.value:null;
    const hasServices=activeServices.size>0;
    const hasTypes=activeTypes.size>0;

    filtered=allProjects.filter(p=>{
      if(city && p.city!==city) return false;
      if(year && p.year!==year) return false;
      if(hasTypes && (!p.type || !activeTypes.has(p.type))) return false;

      const norm=normalizeServices(p.services);
      if(hasServices && ![...activeServices].every(s=>norm.includes(s))) return false;

      if(q){
        const blob=[p.title,p.city,p.year,(p.services||[]).join(' '),p.type||'',p.blurb||''].join(' ').toLowerCase();
        if(!blob.includes(q)) return false;
      }
      return true;
    });
    draw();
  }

  /* Panel toggle */
  const panel    = document.querySelector('.controls');
  const toggleBtn= document.getElementById('toggleFilters');
  const closeBtn = document.getElementById('closeFilters');

  const showPanel   = () => { panel.style.display = '';  toggleBtn.setAttribute('aria-expanded','true');  };
  const hidePanel   = () => { panel.style.display = 'none'; toggleBtn.setAttribute('aria-expanded','false'); };
  const togglePanel = () => { (panel.style.display==='none' || !panel.style.display) ? showPanel() : hidePanel(); };

  toggleBtn.onclick = togglePanel;
  if (closeBtn) closeBtn.onclick = hidePanel;

  /* Start closed on small screens */
  if (matchMedia('(max-width:640px)').matches) hidePanel();

  document.getElementById('apply').onclick=applyFilters;
  document.getElementById('reset').onclick=()=>{
    $q.value=''; $city.value=''; $year.value='';
    activeServices.clear(); [...document.querySelectorAll('#services .chip')].forEach(c=>c.classList.remove('active'));
    activeTypes.clear();    [...document.querySelectorAll('#ptype .chip')].forEach(c=>c.classList.remove('active'));
    filtered=allProjects.slice(); draw();
  };
  let t=null; $q.oninput=()=>{ clearTimeout(t); t=setTimeout(applyFilters,250); };

  /* Kick things off */
  loadData();
</script>
</body>
</html>
