<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ReModa™ | Project Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  :root{
    --navy:#0C1D3A; --navy-700:#122a58; --bg:#0a1227; --white:#fff;
    --ink:#0f1830; --muted:#6e7aa1; --accent:#7cc6ff; --hqglow:#FFD36E;
    --radius:16px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--white);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .page{display:grid;grid-template-rows:auto 1fr;height:100%}

  /* Top bar */
  .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between;
    padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg,var(--navy),#0b1f3f)}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:40px;width:auto}
  .brand .title-wrap{display:flex;flex-direction:column;line-height:1.1}
  .brand .title-wrap span{font-weight:700;letter-spacing:.2px}
  .map-subtitle{font-size:13px;color:rgba(255,255,255,0.7);margin-top:2px}
  .topbar a{color:#cfe8ff;text-decoration:none;font-size:14px}
  .topbar button{background:transparent;border:1px solid rgba(255,255,255,.3);color:#cfe8ff;border-radius:10px;padding:6px 10px;cursor:pointer}

  .map-wrap{position:relative}
  #map{position:absolute;inset:0}
  .map-tint{position:absolute;inset:0;pointer-events:none;z-index:300;
    background:radial-gradient(900px 520px at 50% -8%, rgba(12,29,58,.35) 0%, transparent 60%),
               linear-gradient(180deg, rgba(12,29,58,.40), rgba(12,29,58,.30));
    mix-blend-mode:multiply;}

  /* Controls */
  .controls{position:absolute;top:16px;right:16px;z-index:500;width:min(400px, calc(100vw - 32px));
    background:linear-gradient(180deg, rgba(255,255,255,.97), rgba(255,255,255,.94));
    color:var(--ink);border:1px solid rgba(0,0,0,.08); border-radius:var(--radius);
    overflow:hidden; box-shadow:0 18px 48px rgba(0,0,0,.35)}
  .ribbon{
    display:flex;align-items:center;justify-content:space-between;
    gap:10px;padding:10px 14px;background:linear-gradient(180deg,#133063,#0C1D3A);color:#eaf2ff;border-bottom:1px solid rgba(255,255,255,.08)
  }
  .ribbon img{height:32px;width:auto}
  .ribbon strong{font-size:13px;letter-spacing:.3px}
  .icon-close{
    appearance:none; border:1px solid rgba(255,255,255,.45);
    background:transparent; color:#fff; font-weight:700;
    width:28px; height:28px; line-height:26px; text-align:center;
    border-radius:8px; cursor:pointer; padding:0;
  }
  .icon-close:hover{ background:rgba(255,255,255,.08); }

  .controls header{padding:10px 14px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;justify-content:space-between;align-items:center}
  .controls h2{margin:0;font-size:15px;color:var(--navy)}
  .controls .body{padding:12px 14px;display:grid;gap:10px}
  label{font-size:12px;color:var(--navy);font-weight:700}
  input,select,button{width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#f5f7fb;color:var(--ink);padding:10px 12px;font-size:14px;outline:none}
  input::placeholder{color:#6b7a9b}
  input:focus,select:focus{border-color:var(--navy-700);box-shadow:0 0 0 3px rgba(18,42,88,.18)}
  .row{display:grid;gap:8px}
  .row.inline{grid-template-columns:1fr 1fr;gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid rgba(0,0,0,.15);padding:8px 12px;border-radius:999px;background:#fff;font-size:12px;cursor:pointer;color:var(--ink);font-weight:600}
  .chip.active{border-color:var(--navy-700);box-shadow:0 0 0 2px rgba(18,42,88,.18) inset}
  .footer{padding:10px 14px;border-top:1px solid rgba(0,0,0,.06);display:flex;gap:10px}
  .btn{background:linear-gradient(180deg,#1c3872,#122a58);border:1px solid rgba(0,0,0,.15);padding:10px 12px;border-radius:12px;color:#eaf2ff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#eef2fb;color:var(--ink)}

  /* Popup */
  .popup{min-width:260px;background:#0c1633;color:#eaf2ff;border-radius:12px;border:1px solid rgba(255,255,255,.14);overflow:hidden}
  .pop-img{height:140px;background:#111 center/cover}
  .pop-body{padding:10px 12px}
  .pop-title{margin:0;font-size:15px;font-weight:800}
  .pop-sub{margin:4px 0 6px;color:#cfe0ff;font-size:12px}
  .pop-link{display:inline-block;margin-top:10px;padding:8px 10px;border-radius:10px;background:#1c3872;color:#fff !important;text-decoration:none;border:1px solid rgba(255,255,255,.15)}
  .pop-link:hover{filter:brightness(1.08);text-decoration:underline}
  .leaflet-popup{z-index:1000 !important}

  /* Regular project pins: clean white dots */
  .rmd-pin{width:34px;height:34px;border-radius:50%;background:#fff;box-shadow:0 0 0 2px #0c1633,0 0 16px rgba(124,198,255,.30)}

  /* HQ pin — navy disk + strong gold glow */
  .rmd-hq{
    width:44px;height:44px;border-radius:50%;
    background:#0C1D3A url('images/remoda-pin.png?v=3') center/88% no-repeat;
    box-shadow:0 0 0 3px #0c1633,0 0 24px rgba(255,211,110,.95),0 0 70px rgba(255,211,110,.60);
    position:relative;
  }
  .rmd-hq::before{content:"";position:absolute;inset:-6px;border-radius:50%;box-shadow:0 0 0 2px rgba(255,211,110,.6)}
  .rmd-hq::after{content:"";position:absolute;inset:0;border-radius:50%;box-shadow:0 0 0 0 rgba(255,211,110,.7);animation:rmdPulse 2.2s ease-out infinite}
  @keyframes rmdPulse{0%{box-shadow:0 0 0 0 rgba(255,211,110,.7)}60%{box-shadow:0 0 0 28px rgba(255,211,110,0)}100%{box-shadow:0 0 0 0 rgba(255,211,110,0)}}

  /* Cluster look */
  .marker-cluster-small,.marker-cluster-medium,.marker-cluster-large{background:rgba(16,46,102,.88);color:#eaf2ff;border:2px solid #9bc9ff;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .marker-cluster div{background:transparent;color:#eaf2ff;font-weight:800;border:none}

  /* Privacy note (centered; above map but below panel) */
  .privacy-note{
    position:absolute; left:50%; bottom:10px; transform:translateX(-50%);
    z-index:400; /* ABOVE map/tint (300), BELOW filter panel (500) */
    display:flex; align-items:center; gap:8px;
    font-size:12px; color:rgba(255,255,255,.88);
    padding:6px 10px; border-radius:10px;
    background:rgba(12,29,58,.45);
    -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px);
    border:1px solid rgba(255,255,255,.12);
    pointer-events:none;
  }
  .privacy-note svg{width:14px;height:14px;flex:none;opacity:.95}

  /* Responsive scaling */
  @media (max-width:720px){
    .controls{left:50%;right:auto;transform:translateX(-50%);width:min(94vw,420px)}
    .brand img{height:32px;}
    .ribbon img{height:26px;}
    .privacy-note{font-size:11px; padding:6px 8px; bottom:8px;}
  }
</style>
</head>
<body>
<div class="page">
  <div class="topbar">
    <div class="brand">
      <img src="images/remoda-logo.png" alt="ReModa Logo">
      <div class="title-wrap">
        <span>Project Map</span>
        <div class="map-subtitle">Explore completed ReModa™ projects across Dallas–Fort Worth. Filter by service type to see our work near you.</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <a href="/">Home</a>
      <button id="toggleFilters" aria-expanded="false">Filters</button>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map" aria-label="Interactive map of ReModa completed projects"></div>
    <div class="map-tint" aria-hidden="true"></div>

    <!-- Privacy disclaimer with shield icon -->
    <div class="privacy-note" aria-live="polite">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 2.5l7 3v6.3c0 4.2-2.7 8-7 10.2-4.3-2.2-7-6-7-10.2V5.5l7-3z" stroke="white" stroke-width="1.4" fill="rgba(255,255,255,.12)"/>
        <path d="M9.2 12.3l1.8 1.8 3.8-4.1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>We respect our clients’ privacy — locations are approximate, not exact.</span>
    </div>

    <aside class="controls" aria-label="Project filters">
      <div class="ribbon">
        <div style="display:flex;align-items:center;gap:10px">
          <img src="images/remoda-logo.png" alt="ReModa">
          <strong>ReModa™ • Filter Projects</strong>
        </div>
        <button id="closeFilters" class="icon-close" aria-label="Close filters">×</button>
      </div>
      <header>
        <h2>Explore Completed Projects</h2>
        <small style="color:var(--muted)">Dallas–Fort Worth</small>
      </header>
      <div class="body">
        <div class="row">
          <label for="q">Search</label>
          <input id="q" type="search" placeholder="Client, project, notes…"/>
        </div>
        <div class="row inline">
          <div>
            <label for="city">City</label>
            <select id="city"><option value="">All Cities</option></select>
          </div>
          <div>
            <label for="year">Year</label>
            <select id="year"><option value="">All Years</option></select>
          </div>
        </div>
        <div class="row">
          <label>Service Type</label>
          <div id="services" class="chips"></div>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="apply">Apply Filters</button>
        <button class="btn secondary" id="reset">Reset</button>
      </div>
    </aside>
  </div>
</div>

<script>
  /* --------- 2A: point to your JSON file --------- */
  const DATA_URL = 'data/projects.json?v=1'; // bump ?v= number when you update data

  // Map + tiles (navy feel via overlay)
  const map = L.map('map', { zoomControl:false }).setView([32.7767,-96.7970], 11);
  L.control.zoom({ position:'bottomright' }).addTo(map);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; OpenStreetMap &copy; CARTO', subdomains:'abcd', maxZoom:20
  }).addTo(map);

  // Pins & clustering
  const ReModaIcon = L.DivIcon.extend({ options:{ className:'rmd-pin', iconSize:[34,34] } });
  const clusters = L.markerClusterGroup({
    showCoverageOnHover:false, maxClusterRadius:50, spiderfyOnMaxZoom:true, disableClusteringAtZoom:15
  }).addTo(map);

  // HQ pin (not clustered)
  const HQ_LAT = 32.9453261, HQ_LNG = -96.7355908;
  const ReModaHQIcon = L.DivIcon.extend({
    options:{ className:'rmd-hq', iconSize:[44,44], iconAnchor:[22,40], popupAnchor:[0,-34] }
  });
  const hq = L.marker([HQ_LAT, HQ_LNG], { icon:new ReModaHQIcon(), zIndexOffset:1500 })
    .addTo(map)
    .bindPopup(`
      <div class="popup">
        <img id="hq-photo" alt="ReModa HQ storefront"
             src="images/remoda-hq.jpeg?v=3"
             style="width:100%;height:160px;object-fit:cover;display:block;border-bottom:1px solid rgba(255,255,255,.12)">
        <div class="pop-body">
          <h3 class="pop-title">ReModa™ HQ</h3>
          <p class="pop-sub">401 S. Sherman Street #217 • Richardson, TX 75081</p>
          <a class="pop-link"
             href="https://www.google.com/maps/place/ReModa+%7C+Design+Build/@32.9445931,-96.7387837,17z/data=!4m6!3m5!1s0x864c1d3cc66c761b:0x8493e75d73680e08!8m2!3d32.9453031!4d-96.7356007!16s%2Fg%2F11lf4pjxhs?entry=ttu&g_ep=EgoyMDI1MDgwNi4wIKXMDSoASAFQAw%3D%3D"
             target="_blank" rel="noopener">Directions ›</a>
        </div>
      </div>
    `, { maxWidth: 320 })
    .bindTooltip('ReModa HQ', { direction:'top', offset:[0,-22] })
    .on('popupopen', () => {
      const img = document.getElementById('hq-photo');
      const candidates = [
        'images/remoda-hq.jpeg?v=3','images/remoda-hq.jpg?v=3','images/remoda-hq.webp?v=3','images/remoda-hq.png?v=3',
        'images/Remoda-HQ.jpg?v=3','images/Remoda-HQ.JPG?v=3'
      ];
      let i=0;
      const tryNext=()=>{ if(i>=candidates.length) return; const test=new Image(); const url=candidates[i++]; test.onload=()=>{img.src=url}; test.onerror=tryNext; test.src=url; };
      img.onerror=tryNext;
    });

  // === DATA STATE (now filled by JSON) ===
  let allProjects = [];
  let filtered = [];
  let activeServices = new Set();

  /* --------- 2B: loader that fetches your JSON --------- */
  async function loadData() {
    try {
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load projects.json');
      const data = await res.json();

      // Normalize + validate
      allProjects = (Array.isArray(data) ? data : []).map(p => ({
        id: p.id || (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Math.random())),
        title: p.title || 'Untitled Project',
        city: p.city || '',
        year: Number(p.year) || new Date().getFullYear(),
        services: Array.isArray(p.services) ? p.services : [],
        coords: Array.isArray(p.coords) ? p.coords : null,
        cover: p.cover || '',
        url: p.url || '',
        blurb: p.blurb || ''
      })).filter(p => Array.isArray(p.coords) && p.coords.length === 2);

      filtered = allProjects.slice();

      // Rebuild filters AFTER data loads
      document.getElementById('city').innerHTML = '<option value="">All Cities</option>';
      document.getElementById('year').innerHTML = '<option value="">All Years</option>';
      document.getElementById('services').innerHTML = '';
      populateFilters();
      draw();
    } catch (e) {
      console.error(e);
      filtered = [];
      draw();
    }
  }

  // Filter helpers (unchanged)
  const $city = document.getElementById('city');
  const $year = document.getElementById('year');
  const $services = document.getElementById('services');
  const $q = document.getElementById('q');

  const unique = (list,key)=>[...new Set(list.map(x=>x[key]))].filter(Boolean).sort();
  const uniqueYears = list => [...new Set(list.map(x=>x.year))].filter(Boolean).sort((a,b)=>b-a);

  function populateFilters(){
    unique(allProjects,'city').forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; $city.appendChild(o); });
    uniqueYears(allProjects).forEach(y=>{ const o=document.createElement('option'); o.value=y; o.textContent=y; $year.appendChild(o); });
    ["Kitchen","Bathroom","Flooring","Painting","Exterior","Design Service","Custom Builds"].forEach(s=>{
      const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=s; b.dataset.value=s;
      b.onclick=()=>{ b.classList.toggle('active'); if(activeServices.has(s)) activeServices.delete(s); else activeServices.add(s); };
      $services.appendChild(b);
    });
  }

  function normalizeServices(list){
    const map = {
      "kitchen":"Kitchen",
      "bathroom":"Bathroom","bathrooms":"Bathroom","bath":"Bathroom",
      "floor":"Flooring","flooring":"Flooring",
      "paint":"Painting","painting":"Painting",
      "exterior":"Exterior","outdoor":"Exterior","pergola":"Exterior","patio":"Exterior",
      "design":"Design Service","design service":"Design Service","design-service":"Design Service","design-build":"Design Service",
      "custom":"Custom Builds","custom builds":"Custom Builds","millwork":"Custom Builds","feature wall":"Custom Builds","fireplace":"Custom Builds","accent wall":"Custom Builds"
    };
    return (list||[]).map(s=>String(s).toLowerCase()).map(s=>{
      if(map[s]) return map[s]; for(const k in map){ if(s.includes(k)) return map[k]; } return null;
    }).filter(Boolean).reduce((a,v)=>a.includes(v)?a:[...a,v],[]);
  }

  function popupHTML(p){
    return `
      <div class="popup">
        <div class="pop-img" style="background-image:url('${p.cover||''}')"></div>
        <div class="pop-body">
          <h3 class="pop-title">${p.title}</h3>
          <p class="pop-sub">${p.city} • ${p.year}</p>
          ${p.blurb?`<p style="margin:6px 0 0;color:#cfe0ff">${p.blurb}</p>`:''}
          ${p.url && p.url!=='#' ? `<a class="pop-link" href="${p.url}" target="_blank" rel="noopener">View project ›</a>`:''}
        </div>
      </div>`;
  }

  function draw(){
    clusters.clearLayers();
    const latlngs=[];
    filtered.forEach(p=>{
      const m=L.marker(p.coords,{icon:new ReModaIcon()}).bindPopup(popupHTML(p),{maxWidth:320});
      clusters.addLayer(m); latlngs.push(p.coords);
    });
    if(latlngs.length){ map.fitBounds(latlngs,{padding:[40,40]}); } else { map.flyTo([32.7767,-96.7970],11); }
  }

  function applyFilters(){
    const q=($q.value||'').toLowerCase().trim();
    const city=$city.value; const year=$year.value?+$year.value:null; const hasServices=activeServices.size>0;

    filtered=allProjects.filter(p=>{
      if(city && p.city!==city) return false;
      if(year && p.year!==year) return false;
      const norm=normalizeServices(p.services);
      if(hasServices && ![...activeServices].every(s=>norm.includes(s))) return false;
      if(q){ const blob=[p.title,p.city,p.year,(p.services||[]).join(' '),p.blurb||''].join(' ').toLowerCase(); if(!blob.includes(q)) return false; }
      return true;
    });
    draw();
  }

  // Filter panel toggle + close button
  const panel    = document.querySelector('.controls');
  const toggleBtn= document.getElementById('toggleFilters');
  const closeBtn = document.getElementById('closeFilters');

  const showPanel   = () => { panel.style.display = '';  toggleBtn.setAttribute('aria-expanded','true');  };
  const hidePanel   = () => { panel.style.display = 'none'; toggleBtn.setAttribute('aria-expanded','false'); };
  const togglePanel = () => { (panel.style.display==='none' || !panel.style.display) ? showPanel() : hidePanel(); };

  toggleBtn.onclick = togglePanel;
  if (closeBtn) closeBtn.onclick = hidePanel;

  // Start closed on small screens
  if (matchMedia('(max-width:640px)').matches) hidePanel();

  document.getElementById('apply').onclick=applyFilters;
  document.getElementById('reset').onclick=()=>{ $q.value=''; $city.value=''; $year.value=''; activeServices.clear(); [...$services.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active')); filtered=allProjects.slice(); draw(); };
  let t=null; $q.oninput=()=>{ clearTimeout(t); t=setTimeout(applyFilters,250); };

  /* --------- 2C: kick things off (load JSON) --------- */
  loadData();
</script>
</body>
</html>
